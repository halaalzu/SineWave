{% extends "base_cassette.html" %}

{% block title %}FlowState - Analytics{% endblock %}

{% block vertical_text %}STATS{% endblock %}
{% block right_vertical_text %}ANALYTICS{% endblock %}
{% block red_panel %}{% endblock %}

{% block back_button %}
<button onclick="window.location.href='/'"
    class="absolute top-[100px] left-4 md:left-8 z-10 bg-secondary border-4 border-foreground px-4 py-2 font-display text-lg tracking-widest text-secondary-foreground cursor-pointer btn-3d">
    ‚óÄ BACK
</button>
{% endblock %}

{% block content_margin %}{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block cassette_content %}
<div class="mb-6 mt-8">
    <div class="flex items-center justify-between mb-4">
        <h1 class="font-display text-4xl md:text-5xl tracking-[0.25em] text-foreground leading-[0.9]">
            CLINICAL<br />ANALYTICS
        </h1>
        <div class="flex gap-2">
            <button onclick="window.location.href='/hand-comparison'" 
                    class="px-4 py-2 bg-gradient-to-r from-purple-500 to-blue-500 text-white font-semibold btn-3d">
                ü§ö Compare Hands
            </button>
            <button onclick="loadAnalytics()" 
                    class="bg-secondary border-3 border-foreground px-4 py-2 font-display text-sm tracking-wider text-secondary-foreground btn-3d">
                üîÑ REFRESH
            </button>
        </div>
    </div>
    <p class="text-sm font-bold tracking-wider text-muted-foreground">
        MOST RECENT SESSION ‚Ä¢ JOINT PERFORMANCE ANALYSIS
    </p>
</div>

<div id="loadingState" class="bg-card border-4 border-foreground p-12 text-center" style="box-shadow: 6px 6px 0 hsl(0, 0%, 10%);">
    <div class="font-display text-2xl tracking-widest text-foreground/50">
        LOADING DATA...
    </div>
</div>

<div id="noDataState" class="hidden bg-card border-4 border-foreground p-12 text-center" style="box-shadow: 6px 6px 0 hsl(0, 0%, 10%);">
    <div class="text-5xl mb-4">üéØ</div>
    <div class="font-display text-2xl tracking-widest text-foreground mb-2">
        NO DATA YET
    </div>
    <p class="text-sm font-bold tracking-wider text-foreground/60">
        Complete some sessions in Free Style or Levels mode to see your analytics!
    </p>
</div>

<div id="dataView" class="hidden">
    <!-- FMA Proxy Score -->
    <div class="bg-foreground border-[6px] border-foreground p-5 mb-6 mr-0 md:mr-12" style="box-shadow: 8px 8px 0 hsl(0, 0%, 10%);">
        <div class="flex items-center justify-between">
            <div>
                <div class="font-display text-sm tracking-[0.3em] text-card/60">
                    OVERALL SCORE (MOST RECENT)
                </div>
                <div class="font-display text-6xl tracking-widest text-card">
                    <span id="fmaScore">0</span><span class="text-2xl text-card/50">/100</span>
                </div>
                <div class="text-[10px] font-bold tracking-wider text-card/50 mt-1">
                    FROM LATEST RECORDING SESSION
                </div>
            </div>
            <div class="text-5xl">ü©∫</div>
        </div>
    </div>

    <!-- Main Layout: Hand Visualization + Weekly Progress (side by side) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 mr-0 md:mr-12">
        <!-- Hand Visualization -->
        <div class="md:col-span-2 bg-card border-4 border-foreground p-6" style="box-shadow: 6px 6px 0 hsl(0, 0%, 10%);">
            <div class="font-display text-sm tracking-widest text-foreground/70 mb-4">‚úã JOINT PERFORMANCE MAP</div>
            <canvas id="handCanvas" class="w-full" style="max-height: 400px;"></canvas>
        </div>
        
        <!-- Weekly Progress (Smaller Tab) -->
        <div class="bg-card border-4 border-foreground p-4" style="box-shadow: 6px 6px 0 hsl(0, 0%, 10%);">
            <div class="font-display text-xs tracking-widest text-foreground/70 mb-3">üìà WEEKLY PROGRESS</div>
            <canvas id="progressChart" height="250"></canvas>
        </div>
    </div>

    <!-- Core Metrics -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6 mr-0 md:mr-12">
        <div class="bg-card border-4 border-foreground p-3 relative" style="box-shadow: 4px 4px 0 hsl(0, 0%, 10%);">
            <div class="absolute top-1 left-1 right-1 bottom-1 border border-foreground/15 pointer-events-none"></div>
            <div class="text-2xl">„Ä∞Ô∏è</div>
            <div class="font-display text-xs tracking-widest text-foreground/60">SMOOTHNESS</div>
            <div class="font-display text-3xl tracking-wider text-foreground" id="smoothness">0</div>
            <div class="text-[8px] font-bold tracking-wider text-foreground/40 mt-1">SPARC-BASED</div>
        </div>
        
        <div class="bg-card border-4 border-foreground p-3 relative" style="box-shadow: 4px 4px 0 hsl(0, 0%, 10%);">
            <div class="absolute top-1 left-1 right-1 bottom-1 border border-foreground/15 pointer-events-none"></div>
            <div class="text-2xl">üìê</div>
            <div class="font-display text-xs tracking-widest text-foreground/60">ROM</div>
            <div class="font-display text-3xl tracking-wider text-foreground" id="rom">0</div>
            <div class="text-[8px] font-bold tracking-wider text-foreground/40 mt-1">VS BASELINE</div>
        </div>
        
        <div class="bg-card border-4 border-foreground p-3 relative" style="box-shadow: 4px 4px 0 hsl(0, 0%, 10%);">
            <div class="absolute top-1 left-1 right-1 bottom-1 border border-foreground/15 pointer-events-none"></div>
            <div class="text-2xl">üéØ</div>
            <div class="font-display text-xs tracking-widest text-foreground/60">TRAJECTORY</div>
            <div class="font-display text-3xl tracking-wider text-foreground" id="trajectory">0</div>
            <div class="text-[8px] font-bold tracking-wider text-foreground/40 mt-1">PATH ACCURACY</div>
        </div>
        
        <div class="bg-card border-4 border-foreground p-3 relative" style="box-shadow: 4px 4px 0 hsl(0, 0%, 10%);">
            <div class="absolute top-1 left-1 right-1 bottom-1 border border-foreground/15 pointer-events-none"></div>
            <div class="text-2xl">üîÑ</div>
            <div class="font-display text-xs tracking-widest text-foreground/60">CONSISTENCY</div>
            <div class="font-display text-3xl tracking-wider text-foreground" id="consistency">0</div>
            <div class="text-[8px] font-bold tracking-wider text-foreground/40 mt-1">TRIAL VARIANCE</div>
        </div>
    </div>

    <!-- Joint Details Grid -->
    <div class="bg-card border-4 border-foreground p-4 mb-6 mr-0 md:mr-12" style="box-shadow: 6px 6px 0 hsl(0, 0%, 10%);">
        <div class="font-display text-sm tracking-widest text-foreground/70 mb-4">üìä JOINT DETAILS</div>
        <div id="jointGrid" class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <!-- Populated by JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Hand landmark positions (normalized 0-1, will be scaled to canvas)
const HAND_LANDMARKS = {
    0: [0.5, 0.9],    // Wrist
    1: [0.45, 0.75],  2: [0.42, 0.6],   3: [0.40, 0.45],  4: [0.38, 0.3],   // Thumb
    5: [0.50, 0.55],  6: [0.50, 0.35],  7: [0.50, 0.20],  8: [0.50, 0.05],  // Index
    9: [0.60, 0.58],  10: [0.62, 0.38], 11: [0.63, 0.22], 12: [0.64, 0.08], // Middle
    13: [0.70, 0.60], 14: [0.73, 0.42], 15: [0.75, 0.28], 16: [0.76, 0.15], // Ring
    17: [0.78, 0.65], 18: [0.82, 0.50], 19: [0.85, 0.38], 20: [0.87, 0.28]  // Pinky
};

const HAND_CONNECTIONS = [
    [0, 1], [1, 2], [2, 3], [3, 4],       // Thumb
    [0, 5], [5, 6], [6, 7], [7, 8],       // Index
    [0, 9], [9, 10], [10, 11], [11, 12],  // Middle
    [0, 13], [13, 14], [14, 15], [15, 16],// Ring
    [0, 17], [17, 18], [18, 19], [19, 20],// Pinky
    [5, 9], [9, 13], [13, 17]             // Palm
];

const JOINT_NAMES = {
    0: "Wrist", 1: "Thumb CMC", 2: "Thumb MCP", 3: "Thumb IP", 4: "Thumb Tip",
    5: "Index MCP", 6: "Index PIP", 7: "Index DIP", 8: "Index Tip",
    9: "Middle MCP", 10: "Middle PIP", 11: "Middle DIP", 12: "Middle Tip",
    13: "Ring MCP", 14: "Ring PIP", 15: "Ring DIP", 16: "Ring Tip",
    17: "Pinky MCP", 18: "Pinky PIP", 19: "Pinky DIP", 20: "Pinky Tip"
};

let jointScoreData = {};

function drawHandVisualization(jointData) {
    const canvas = document.getElementById('handCanvas');
    const ctx = canvas.getContext('2d');
    
    // Set canvas size
    canvas.width = 500;
    canvas.height = 500;
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Create joint score map
    jointScoreData = {};
    jointData.forEach(joint => {
        const idx = parseInt(joint.label.split('_')[1]);
        jointScoreData[idx] = joint.score;
    });
    
    // Draw connections first
    ctx.lineWidth = 4;
    HAND_CONNECTIONS.forEach(([start, end]) => {
        const startPos = HAND_LANDMARKS[start];
        const endPos = HAND_LANDMARKS[end];
        const avgScore = ((jointScoreData[start] || 50) + (jointScoreData[end] || 50)) / 2;
        ctx.strokeStyle = getScoreColor(avgScore);
        ctx.beginPath();
        ctx.moveTo(startPos[0] * canvas.width, startPos[1] * canvas.height);
        ctx.lineTo(endPos[0] * canvas.width, endPos[1] * canvas.height);
        ctx.stroke();
    });
    
    // Draw joints
    Object.keys(HAND_LANDMARKS).forEach(idx => {
        const pos = HAND_LANDMARKS[idx];
        const x = pos[0] * canvas.width;
        const y = pos[1] * canvas.height;
        const score = jointScoreData[idx] || 50;
        
        // Joint circle
        ctx.fillStyle = getScoreColor(score);
        ctx.beginPath();
        ctx.arc(x, y, 12, 0, 2 * Math.PI);
        ctx.fill();
        
        // Border
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // Score text
        ctx.fillStyle = '#000';
        ctx.font = 'bold 10px monospace';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(Math.round(score), x, y);
    });
    
    // Legend
    ctx.font = '12px monospace';
    ctx.textAlign = 'left';
    const legendY = canvas.height - 30;
    
    ctx.fillStyle = '#22c55e';
    ctx.fillRect(10, legendY, 15, 15);
    ctx.fillStyle = '#000';
    ctx.fillText('Good (70+)', 30, legendY + 10);
    
    ctx.fillStyle = '#eab308';
    ctx.fillRect(120, legendY, 15, 15);
    ctx.fillStyle = '#000';
    ctx.fillText('Fair (40-70)', 140, legendY + 10);
    
    ctx.fillStyle = '#ef4444';
    ctx.fillRect(250, legendY, 15, 15);
    ctx.fillStyle = '#000';
    ctx.fillText('Poor (<40)', 270, legendY + 10);
}

function getScoreColor(score) {
    if (score >= 70) return '#22c55e'; // Green
    if (score >= 40) return '#eab308'; // Yellow
    return '#ef4444'; // Red
}

async function loadAnalytics() {
    try {
        const response = await fetch('/api/user/default_user/analytics');
        if (!response.ok) throw new Error('No data');
        
        const data = await response.json();
        
        document.getElementById('loadingState').classList.add('hidden');
        
        if (!data.jointData || data.jointData.length === 0) {
            document.getElementById('noDataState').classList.remove('hidden');
            return;
        }
        
        document.getElementById('noDataState').classList.add('hidden');
        document.getElementById('dataView').classList.remove('hidden');
        
        // Update FMA Score (from most recent)
        const fmaScore = data.weeklyProgress && data.weeklyProgress.length > 0 
            ? data.weeklyProgress[data.weeklyProgress.length - 1].fmaProxy 
            : 0;
        document.getElementById('fmaScore').textContent = fmaScore;
        
        // Update metrics (from most recent session)
        document.getElementById('smoothness').textContent = (data.overallScores.smoothness || 0).toFixed(0);
        document.getElementById('rom').textContent = (data.overallScores.rom || 0).toFixed(0);
        document.getElementById('trajectory').textContent = (data.overallScores.trajectory || 0).toFixed(0);
        document.getElementById('consistency').textContent = (data.overallScores.consistency || 0).toFixed(0);
        
        // Draw hand visualization
        drawHandVisualization(data.jointData);
        
        // Weekly progress chart (smaller)
        if (data.weeklyProgress && data.weeklyProgress.length > 0) {
            const ctx = document.getElementById('progressChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.weeklyProgress.map(d => new Date(d.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})),
                    datasets: [{
                        label: 'Score',
                        data: data.weeklyProgress.map(d => d.fmaProxy),
                        borderColor: 'hsl(0, 52%, 54%)',
                        backgroundColor: 'hsla(0, 52%, 54%, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Score: ${context.parsed.y}`
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            ticks: { font: { size: 10 } }
                        },
                        x: {
                            ticks: { font: { size: 9 } }
                        }
                    }
                }
            });
        }
        
        // Joint details grid
        const jointGrid = document.getElementById('jointGrid');
        jointGrid.innerHTML = '';
        data.jointData.slice(0, 20).forEach(joint => {
            const scoreColor = joint.score >= 70 ? 'text-green-600' : joint.score >= 40 ? 'text-yellow-600' : 'text-red-600';
            const idx = parseInt(joint.label.split('_')[1]);
            const jointName = JOINT_NAMES[idx] || joint.label;
            
            const el = document.createElement('div');
            el.className = 'bg-card border-2 border-foreground p-2';
            el.style.boxShadow = '2px 2px 0 hsl(0, 0%, 10%)';
            el.innerHTML = `
                <div class="font-display text-[10px] tracking-wider text-foreground/60">${jointName}</div>
                <div class="font-display text-xl tracking-wider ${scoreColor}">${joint.score.toFixed(0)}</div>
            `;
            jointGrid.appendChild(el);
        });
        
    } catch (error) {
        console.error('Error loading analytics:', error);
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('noDataState').classList.remove('hidden');
    }
}

// Load on page load
loadAnalytics();
</script>
{% endblock %}
