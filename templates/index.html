<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowState - Hand Tracking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: white;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .video-container {
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            max-width: 1320px;
            width: 100%;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn.primary {
            background: rgba(103, 126, 234, 0.8);
            border-color: rgba(103, 126, 234, 1);
        }

        .btn.primary:hover {
            background: rgba(103, 126, 234, 1);
        }

        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
            max-width: 1320px;
            width: 100%;
        }

        .info-card {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .info-card h3 {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-card p {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ade80;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .video-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ FlowState</h1>
        <p class="subtitle">Real-time Hand Tracking with MediaPipe</p>
    </div>

    <div class="video-container">
        <div class="video-wrapper">
            <img id="video" src="{{ url_for('video_feed') }}" alt="Camera Feed">
        </div>
        
        <div class="controls">
            <button class="btn primary" onclick="location.reload()">
                üîÑ Refresh Feed
            </button>
            <button class="btn" onclick="toggleFullscreen()">
                ‚õ∂ Fullscreen
            </button>
        </div>
    </div>

    <div class="info-cards">
        <div class="info-card">
            <h3><span class="status"></span>Status</h3>
            <p id="status-text">Live</p>
        </div>
        <div class="info-card">
            <h3>Current Pose</h3>
            <p id="current-pose">-</p>
        </div>
        <div class="info-card">
            <h3>Last Note</h3>
            <p id="last-note">-</p>
        </div>
        <div class="info-card">
            <h3>üéµ Hot Cross Buns</h3>
            <p style="font-size: 1rem;">1-2-3, 1-2-3</p>
        </div>
    </div>

    <div class="footer">
        <p>Make poses to play notes: ‚òùÔ∏è (E) ¬∑ ‚úåÔ∏è (D) ¬∑ ü§ü (C)</p>
    </div>

    <script>
        // Web Audio API for playing piano notes
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let lastPose = null;
        
        // Note frequencies for Hot Cross Buns (E-D-C)
        const POSE_NOTES = {
            '1': { freq: 329.63, name: 'E' },  // E4
            '2': { freq: 293.66, name: 'D' },  // D4
            '3': { freq: 261.63, name: 'C' }   // C4
        };

        function generatePianoTone(frequency, duration = 0.5) {
            const now = audioContext.currentTime;
            
            // Create oscillators for harmonics
            const oscillators = [];
            const gains = [];
            const harmonics = [
                { mult: 1.0, amp: 1.0 },
                { mult: 2.0, amp: 0.5 },
                { mult: 3.0, amp: 0.25 },
                { mult: 4.0, amp: 0.125 },
                { mult: 5.0, amp: 0.0625 }
            ];
            
            // Master gain
            const masterGain = audioContext.createGain();
            masterGain.connect(audioContext.destination);
            
            // ADSR envelope
            const attackTime = 0.01;
            const decayTime = 0.05;
            const sustainLevel = 0.6;
            const releaseTime = 0.1;
            
            masterGain.gain.setValueAtTime(0, now);
            masterGain.gain.linearRampToValueAtTime(0.3, now + attackTime);
            masterGain.gain.linearRampToValueAtTime(0.3 * sustainLevel, now + attackTime + decayTime);
            masterGain.gain.setValueAtTime(0.3 * sustainLevel, now + duration - releaseTime);
            masterGain.gain.linearRampToValueAtTime(0, now + duration);
            
            // Create harmonics
            harmonics.forEach(harmonic => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(frequency * harmonic.mult, now);
                gain.gain.setValueAtTime(harmonic.amp / harmonics.length, now);
                
                osc.connect(gain);
                gain.connect(masterGain);
                
                osc.start(now);
                osc.stop(now + duration);
                
                oscillators.push(osc);
                gains.push(gain);
            });
        }

        function playNote(pose) {
            if (POSE_NOTES[pose]) {
                const noteInfo = POSE_NOTES[pose];
                console.log(`üéµ Playing note ${noteInfo.name} (${noteInfo.freq} Hz) for pose ${pose}`);
                
                // Update UI
                document.getElementById('last-note').textContent = noteInfo.name;
                
                // Play the note
                generatePianoTone(noteInfo.freq, 0.5);
            }
        }

        function checkForPoseChange() {
            // Poll the server for current pose status
            fetch('/api/current_pose')
                .then(response => response.json())
                .then(data => {
                    const currentPose = data.pose;
                    
                    // Update UI
                    if (currentPose && currentPose !== 'palm' && currentPose !== 'fist') {
                        document.getElementById('current-pose').textContent = currentPose;
                    } else {
                        document.getElementById('current-pose').textContent = currentPose || '-';
                    }
                    
                    // Play note if pose changed
                    if (currentPose && currentPose !== lastPose && POSE_NOTES[currentPose]) {
                        playNote(currentPose);
                        lastPose = currentPose;
                    } else if (!POSE_NOTES[currentPose]) {
                        lastPose = currentPose;
                    }
                })
                .catch(err => console.error('Error fetching pose:', err));
        }

        // Initialize audio context on user interaction
        document.body.addEventListener('click', () => {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }, { once: true });

        // Start polling for pose changes
        setInterval(checkForPoseChange, 100); // Check every 100ms

        function toggleFullscreen() {
            const videoWrapper = document.querySelector('.video-wrapper');
            if (!document.fullscreenElement) {
                videoWrapper.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Handle video loading errors
        document.getElementById('video').onerror = function() {
            this.alt = 'Camera feed unavailable. Please check camera permissions.';
            this.style.background = '#1a1a1a';
            this.style.minHeight = '400px';
        };
    </script>
</body>
</html>
