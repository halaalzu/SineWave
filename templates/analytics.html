{% extends "base_cassette.html" %}

{% block title %}FlowState - Analytics{% endblock %}

{% block vertical_text %}STATS{% endblock %}
{% block right_vertical_text %}ANALYTICS{% endblock %}
{% block red_panel %}{% endblock %}

{% block back_button %}
<button onclick="window.location.href='/'"
    class="absolute top-[100px] left-4 md:left-8 z-10 bg-secondary border-4 border-foreground px-4 py-2 font-display text-lg tracking-widest text-secondary-foreground cursor-pointer btn-3d">
    ‚óÄ BACK
</button>
{% endblock %}

{% block content_margin %}{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block cassette_content %}
<div class="mb-6 mt-8">
    <div class="flex items-center justify-between mb-4">
        <h1 class="font-display text-4xl md:text-5xl tracking-[0.25em] text-foreground leading-[0.9]">
            CLINICAL<br />ANALYTICS
        </h1>
        <div class="flex gap-2">
            <button onclick="window.location.href='/session-analytics'" 
                    class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold btn-3d">
                üìä Session Comparison
            </button>
            <button onclick="window.location.href='/hand-comparison'" 
                    class="px-4 py-2 bg-gradient-to-r from-purple-500 to-blue-500 text-white font-semibold btn-3d">
                ü§ö Compare Hands
            </button>
            <button onclick="loadSessions()" 
                    class="bg-secondary border-3 border-foreground px-4 py-2 font-display text-sm tracking-wider text-secondary-foreground btn-3d">
                üîÑ REFRESH
            </button>
        </div>
    </div>
    <p class="text-sm font-bold tracking-wider text-muted-foreground">
        SESSION-BASED ANALYSIS ‚Ä¢ SELECT A SESSION FOR DETAILED ANALYTICS
    </p>
</div>

<!-- Session Selection -->
<div class="bg-card border-4 border-foreground p-6 mb-6" style="box-shadow: 6px 6px 0 hsl(0, 0%, 10%);">
    <div class="text-center">
        <div class="font-display text-xl tracking-widest text-foreground mb-4">üìÖ SELECT A SESSION TO ANALYZE</div>
        <div class="mb-4">
            <select id="sessionSelect" 
                    class="w-full max-w-md p-3 bg-background border-4 border-foreground font-mono text-sm mx-auto">
                <option value="">Loading sessions...</option>
            </select>
        </div>
        <button onclick="analyzeSelectedSession()" 
                class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-semibold btn-3d disabled:opacity-50" 
                id="analyzeBtn" disabled>
            üîç ANALYZE SESSION
        </button>
    </div>
</div>

<!-- Session List -->
<div class="bg-card border-4 border-foreground p-6 mb-6" style="box-shadow: 6px 6px 0 hsl(0, 0%, 10%);">
    <div class="font-display text-lg tracking-widest text-foreground mb-4">üìã RECENT SESSIONS</div>
    <div id="sessionList" class="space-y-3">
        <div class="text-center text-muted-foreground">Loading sessions...</div>
    </div>
</div>

<div id="noDataState" class="bg-card border-4 border-foreground p-12 text-center" style="box-shadow: 6px 6px 0 hsl(0, 0%, 10%);">
    <div class="text-5xl mb-4">üéØ</div>
    <div class="font-display text-2xl tracking-widest text-foreground mb-2">
        NO SESSIONS YET
    </div>
    <p class="text-sm font-bold tracking-wider text-foreground/60">
        Complete some sessions in Free Style or Levels mode to see analytics!
    </p>
</div>

<div id="dataView" style="display: none;">
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadSessions() {
    try {
        const response = await fetch('/api/sessions');
        const sessions = await response.json();
        
        const sessionSelect = document.getElementById('sessionSelect');
        const sessionList = document.getElementById('sessionList');
        const noDataState = document.getElementById('noDataState');
        
        if (sessions && sessions.length > 0) {
            // Populate dropdown
            sessionSelect.innerHTML = '<option value="">Select a session...</option>';
            sessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.id;
                const date = new Date(session.timestamp).toLocaleDateString();
                const time = new Date(session.timestamp).toLocaleTimeString();
                option.textContent = `${date} ${time} - ${session.mode || 'Freestyle'}`;
                sessionSelect.appendChild(option);
            });
            
            // Enable analyze button when session is selected
            sessionSelect.onchange = function() {
                const analyzeBtn = document.getElementById('analyzeBtn');
                analyzeBtn.disabled = !this.value;
            };
            
            // Populate session list
            sessionList.innerHTML = '';
            sessions.slice(0, 10).forEach(session => {
                const sessionItem = document.createElement('div');
                sessionItem.className = 'p-3 bg-background border-2 border-foreground flex justify-between items-center cursor-pointer hover:bg-foreground hover:text-background transition-colors';
                sessionItem.onclick = () => {
                    sessionSelect.value = session.id;
                    sessionSelect.onchange();
                    analyzeSelectedSession();
                };
                
                const date = new Date(session.timestamp).toLocaleDateString();
                const time = new Date(session.timestamp).toLocaleTimeString();
                
                sessionItem.innerHTML = `
                    <div>
                        <div class="font-display text-sm tracking-wider">${date} ${time}</div>
                        <div class="text-xs text-muted-foreground">${session.mode || 'Freestyle'} ‚Ä¢ ${session.duration || 'Unknown'} duration</div>
                    </div>
                    <div class="text-xl">üìä</div>
                `;
                
                sessionList.appendChild(sessionItem);
            });
            
            noDataState.style.display = 'none';
        } else {
            sessionSelect.innerHTML = '<option value="">No sessions available</option>';
            sessionList.innerHTML = '<div class="text-center text-muted-foreground">No sessions found</div>';
            noDataState.style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading sessions:', error);
        const sessionSelect = document.getElementById('sessionSelect');
        const sessionList = document.getElementById('sessionList');
        sessionSelect.innerHTML = '<option value="">Error loading sessions</option>';
        sessionList.innerHTML = '<div class="text-center text-red-500">Error loading sessions</div>';
    }
}

function analyzeSelectedSession() {
    const sessionId = document.getElementById('sessionSelect').value;
    if (!sessionId) {
        alert('Please select a session first');
        return;
    }
    
    // Redirect to session analytics page with the selected session
    window.location.href = `/session-analytics?session_id=${sessionId}`;
}

// Load sessions on page load
loadSessions();
</script>
{% endblock %}
